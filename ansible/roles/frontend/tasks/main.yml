# Role: frontend - Deploy React app with Docker + Nginx
---
- name: Create app directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'

- name: Clone/update repository
  git:
    repo: "{{ git_repo }}"
    dest: "{{ app_dir }}"
    version: "{{ git_branch }}"
    force: yes
  become_user: "{{ app_user }}"
  notify: Rebuild and restart container

- name: Copy docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: "{{ app_dir }}/docker-compose.yml"
    owner: "{{ app_user }}"
    mode: '0644'
  notify: Rebuild and restart container

- name: Ensure docker directory exists
  file:
    path: "{{ app_dir }}/docker"
    state: directory
    owner: "{{ app_user }}"
    mode: '0755'

- name: Copy nginx.conf
  template:
    src: nginx.conf.j2
    dest: "{{ app_dir }}/docker/nginx.conf"
    owner: "{{ app_user }}"
    mode: '0644'
  notify: Rebuild and restart container

- name: Copy Dockerfile
  template:
    src: Dockerfile.j2
    dest: "{{ app_dir }}/docker/Dockerfile"
    owner: "{{ app_user }}"
    mode: '0644'
  notify: Rebuild and restart container

- name: Build and start container
  shell: |
    cd {{ app_dir }}
    docker compose build
    docker compose up -d
  become_user: "{{ app_user }}"

- name: Ensure container is running
  shell: docker compose -f {{ app_dir }}/docker-compose.yml ps
  become_user: "{{ app_user }}"
  register: compose_status
  changed_when: false

# SSL avec Certbot (premiere fois uniquement)
- name: Check if SSL certificate exists
  stat:
    path: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
  register: ssl_cert

- name: Install Certbot
  apt:
    name:
      - certbot
    state: present
  when: not ssl_cert.stat.exists

- name: Obtain SSL certificate (standalone mode)
  command: >
    certbot certonly --standalone
    --non-interactive --agree-tos
    --email {{ certbot_email }}
    -d {{ domain_name }}
  when: not ssl_cert.stat.exists
  notify: Rebuild and restart container

- name: Setup certificate renewal cron
  cron:
    name: "Certbot renewal"
    minute: "0"
    hour: "3"
    job: "certbot renew --quiet --post-hook 'docker compose -f {{ app_dir }}/docker-compose.yml restart'"
    user: root

