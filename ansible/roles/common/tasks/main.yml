# Role: common - Packages de base, firewall, securite
---
- name: Wait for cloud-init to finish
  command: cloud-init status --wait
  changed_when: false
  ignore_errors: yes

- name: Wait for apt lock to be released
  shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done
  changed_when: false

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install base packages
  apt:
    name:
      - curl
      - git
      - ufw
      - fail2ban
      - acl
      - htop
      - vim
    state: present

- name: Create deploy user
  user:
    name: "{{ app_user }}"
    shell: /bin/bash
    groups: [sudo, "{{ app_group }}"]
    append: yes

- name: Setup SSH key for deploy user
  authorized_key:
    user: "{{ app_user }}"
    key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
    state: present
  ignore_errors: yes

- name: Allow deploy user to manage docker
  lineinfile:
    path: /etc/sudoers.d/deploy
    line: "{{ app_user }} ALL=(ALL) NOPASSWD: /usr/bin/docker, /usr/bin/docker-compose"
    create: yes
    validate: 'visudo -cf %s'
    mode: '0440'

# Firewall
- name: Configure UFW rules
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - '22'   # SSH
    - '80'   # HTTP
    - '443'  # HTTPS

- name: Enable UFW with default deny
  ufw:
    state: enabled
    policy: deny

# Fail2ban
- name: Configure fail2ban
  copy:
    content: |
      [sshd]
      enabled = true
      bantime = 3600
      maxretry = 5
      findtime = 600
    dest: /etc/fail2ban/jail.local
    mode: '0644'
  notify: Restart fail2ban

